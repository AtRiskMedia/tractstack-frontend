---
import Layout from "@layouts/Layout.astro";
import PaneReact from "@components/PaneReact.tsx";
import { getAllStoryFragmentDatum, getAllPaneDatum } from "../api/drupal";
import type {
  MenuDatum,
  TractStack,
  Pane,
  PaneDatum,
  PaneNode,
  StoryFragmentDatum,
  StoryFragment,
  StoryFragmentProps,
} from "../types";

export async function getStaticPaths() {
  const storyFragments: StoryFragmentDatum[] = await getAllStoryFragmentDatum();
  const panes: PaneDatum[] = await getAllPaneDatum();
  const pathsPromises: Promise<{
    params: { slug: string };
    props: StoryFragmentProps;
  }>[] = storyFragments.map(async (storyFragment: StoryFragmentDatum) => {
    const date = new Date(storyFragment.changed);
    const msTimecode = date.getTime();
    const thisPanes = storyFragment.field_panes.map((p: PaneNode) => p.id);

    return {
      params: { slug: storyFragment.field_slug },
      props: {
        title: storyFragment.title,
        id: storyFragment.id,
        slug: storyFragment.field_slug,
        drupalNid: storyFragment.drupal_internal__nid,
        socialImagePath: storyFragment.field_social_image_path || undefined,
        tailwindBgColour:
          storyFragment.field_tailwind_background_colour || undefined,
        menu: storyFragment.field_menu,
        panes: storyFragment.field_panes,
        panesPayload: panes.filter((payload: PaneDatum) =>
          thisPanes.includes(payload.id)
        ),
        tractStackId: storyFragment.field_tract_stack.id,
        tractStackTitle: storyFragment.field_tract_stack.title,
        tractStackSlug: storyFragment.field_tract_stack.field_slug,
        changed: msTimecode,
      },
    };
  });
  return Promise.all(pathsPromises);
}
const {
  title,
  id,
  slug,
  drupalNid,
  socialImagePath,
  menu,
  panes,
  panesPayload,
  tractStackId,
  tractStackTitle,
  tractStackSlug,
  changed,
}: StoryFragmentProps = Astro.props;
const current = {
  id,
  slug,
  type: `StoryFragment`,
  parentId: tractStackId,
  parentSlug: tractStackSlug,
  parentType: `TractStack`,
};
console.log(panesPayload);
export const prerender = true;
---

<h1>{title}</h1>
<h2>Story Fragment</h2>
<p><strong>slug:</strong> {slug}</p>
<p><strong>id:</strong> {id}</p>
<p><strong>changed:</strong> {changed}</p>
<h2>Parent</h2>
<p>{tractStackTitle}</p>
<p><strong>slug:</strong> {tractStackSlug}</p>
<p><strong>id:</strong> {tractStackId}</p>
{
  !!menu ? (
    <>
      <h2>Menu</h2>
      <p>{JSON.stringify(menu)}</p>
    </>
  ) : null
}
<h2>Panes</h2>
<astro-storyfragment data-id={JSON.stringify(current)}>
  <ul>
    {
      panes.map((pane: PaneNode, idx: number) => (
        <astro-pane key={`pane-${pane.id}`}>
          <li id={`pane-${pane.id}`} class="pane">
            {idx <= 2 ? (
              <PaneReact client:load id={pane.id} />
            ) : (
              <PaneReact client:visible id={pane.id} />
            )}
          </li>
        </astro-pane>
      ))
    }
  </ul>
</astro-storyfragment>

<astro-link data-id={`welcome`}>
  <a class="text-yellow-300 hover:text-black" href="/welcome">welcome</a>
</astro-link>
<astro-link data-id={`get`}>
  <a href="/get">get</a>
</astro-link>
<astro-link data-id={`agency`}>
  <a href="/agency">agency</a>
</astro-link>
<astro-link data-id={`#`}>
  <a href="#">#</a>
</astro-link>

<script>
  import { init } from "../utils/init";
  init();
</script>
